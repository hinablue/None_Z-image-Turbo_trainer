# LongCat-Image 加速 LoRA 训练配置
# 使用 Rectified Flow 方法训练 10 步加速 LoRA

[model]
# Transformer 模型路径
dit = "/path/to/longcat-image/transformer"

# VAE 路径（可选，默认使用模型目录下的 vae）
# vae = "/path/to/longcat-image/vae"

# 输出目录
output_dir = "output/longcat_turbo"
output_name = "longcat-turbo-lora"

[turbo]
# 目标加速步数
turbo_steps = 10

# 时间步 shift 参数（LongCat 使用动态 shift）
use_dynamic_shifting = true
base_shift = 0.5
max_shift = 1.15

# 锚点抖动幅度
jitter_scale = 0.02

# 使用锚点采样（推荐开启）
use_anchor = true

# RAFT 混合模式（增强构图学习）
# 同 batch 内混合锚点流和全时间步自由流
raft_mode = false
free_stream_ratio = 0.3  # 自由流比例 0.3=30%

# Latent Jitter（构图突破 - 核心参数）
# 在 x_t 上添加空间抖动，推荐 0.03-0.05
latent_jitter_scale = 0.0

[lora]
# LoRA rank（加速训练建议 32-64）
network_dim = 32
network_alpha = 16

# 使用 PEFT 库（LongCat 推荐）
use_peft = true

[training]
optimizer_type = "AdamW8bit"
learning_rate = 1e-4
weight_decay = 0.01
lr_scheduler = "cosine"
lr_warmup_steps = 100
lr_num_cycles = 1
num_train_epochs = 10
save_every_n_epochs = 1
gradient_accumulation_steps = 2
seed = 42

# 基础损失权重
lambda_l1 = 1.0
lambda_cosine = 0.1

# 频域感知 (开关+权重)
enable_freq = false
lambda_freq = 0.3

# 风格结构 (开关+权重)
enable_style = false
lambda_style = 0.3

# SNR 加权
snr_gamma = 5.0
snr_floor = 0.1

[advanced]
max_grad_norm = 1.0
gradient_checkpointing = true
mixed_precision = "bf16"

[dataset]
batch_size = 1
num_workers = 4
shuffle = true
enable_bucket = true

# 文本编码最大序列长度 (需与缓存时一致)
# LongCat 支持更长序列, 推荐: 512 (默认), 1024 (长描述)
max_sequence_length = 512

# 缓存架构标识 (lc: LongCat-Image)
cache_arch = "lc"

[[dataset.sources]]
cache_directory = "/path/to/your/dataset/cache"
num_repeats = 10
resolution_limit = 1024

